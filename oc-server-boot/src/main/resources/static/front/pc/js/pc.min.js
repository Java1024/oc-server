function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var e=t(),r={};function t(){$(".p-view").on("click","img",function(e){a(this)})}function a(e){var t=$(window).width(),n=$(window).height(),a=e.naturalWidth,i=e.naturalHeight;t<a&&(a=t,i-=parseInt(a/i*(a-t))),n<i&&(i=n,a-=parseInt(i/a*(i-n))),r.src=e.src,r.rotate=0,r.change=!1,r.scale=100,r.height=i,r.width=a,r.top=parseInt(n/2-r.height/2),r.left=parseInt(t/2-r.width/2);var c='<div id="p_img_container" style="left:'+r.left+"px; top: "+r.top+'px;">',o='<img id="p_img" src="'+r.src+'" style="width: '+r.width+'px;" />';$("#p_img_mask_wrapper").remove();var s='<div id="p_img_mask_wrapper"><div id="p-view-close-container"><div id="p-view-close"></div></div>'+c+o+'</div><div id="p_img_tip"></div><div id="p_img_opts"><span id="p_img_plus_btn" title="放大"></span><span id="p_img_minus_btn" title="缩小"></span><span id="p_img_rotate_btn" title="旋转"></span><span id="p_img_reset_btn" title="重置"></span></div></div>';$("body").append(s),d()}function d(){$("#p_img_mask_wrapper").unbind("click").bind("click",function(){v.stopPropagation(event),$("#p_img_mask_wrapper").remove(),r={}}),$("#p_img_container").unbind("click").bind("click",function(){v.stopPropagation(event)}),$("#p_img_plus_btn").unbind("click").bind("click",function(){var e;v.stopPropagation(event),r.scale+=10,260<=r.scale?(r.scale=260,$("#p_img_tip").html("已经是最大比例"+r.scale+"%").finish().fadeIn().delay(1500).fadeOut()):(e=r.scale/100,$("#p_img_tip").html(r.scale+"%").finish().fadeIn().delay(1500).fadeOut(),$("#p_img").width(r.width*e)),r.change||c()}),$("#p_img_minus_btn").unbind("click").bind("click",function(){var e;v.stopPropagation(event),r.scale-=10,r.scale<=0?(r.scale=10,$("#p_img_tip").html("已是最小比例"+r.scale+"%").finish().fadeIn().delay(1500).fadeOut()):(e=r.scale/100,$("#p_img_tip").html(r.scale+"%").finish().fadeIn().delay(1500).fadeOut(),$("#p_img").width(r.width*e)),r.change||c()}),$("#p_img_rotate_btn").unbind("click").bind("click",function(){v.stopPropagation(event),r.rotate=r.rotate+90,360<r.rotate&&(r.rotate=90),$("#p_img_tip").html("旋转"+r.rotate+"度").finish().fadeIn().delay(1500).fadeOut(),$("#p_img").css("transform","rotate("+r.rotate+"deg)")}),$("#p_img_reset_btn").unbind("click").bind("click",function(e){v.stopPropagation(e),$("#p_img_tip").html("重置").finish().fadeIn().delay(1500).fadeOut(),$("#p_img").width(r.width),$("#p_img").css("transform","rotate(0deg)"),c(),r.scale=100,r.change=!1});var i=$("#p_img_container");i.bind("mousedown",function(e){var t,n,a;return v.stopPropagation(e),0==e.button&&($("#p_img_opts").hide(),t=i.offset(),n=e.pageX-t.left,a=e.pageY-t.top,i.unbind("mousemove").bind("mousemove",function(e){return r.change=!0,i.css("left",e.pageX-n+"px"),i.css("top",e.pageY-a+"px"),!1}),i.unbind("mouseup").bind("mouseup",function(){i.unbind("mousemove"),$("#p_img_opts").show()})),!1})}function c(){var e=$(window).width(),t=$(window).height(),n=$("#p_img").width(),a=$("#p_img").height();$("#p_img_container").css({left:e/2-n/2+"px",top:t/2-a/2})}var l={filterHtmlJsSpaceEnter:function(e){return e&&0<e.length&&(e=(e=e.replace(/[\s| | ]*\r/gi," ")).replace(/<(?!br([/]*)>)[^>]*>/gi,"")),e},htmlEncodeByRegExp:function(e){return 0==e.length?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/ /g," ").replace(/\'/g,"&#39;").replace(/\"/g,"&quot;")},htmlDecodeByRegExp:function(e){return 0==e.length?"":e.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&nbsp;/g," ").replace(/&#39;/g,"'").replace(/&quot;/g,'"')},htmlTurnCharacter:function(e){if(0==e.length)return"";return e.replace(/(.*?)<img.*?alt="(.*?)">/gi,"$1$2")}};function i(){$("[contenteditable]").each(function(){try{document.execCommand("AutoUrlDetect",!1,!1)}catch(e){}$(this).on("paste",function(e){e.preventDefault();var t,n,a=null;if(!(a=window.clipboardData&&clipboardData.setData?window.clipboardData.getData("text"):(e.originalEvent||e).clipboardData.getData("text/plain")))return!1;document.body.createTextRange?(console.log("insert Text"),document.selection?textRange=document.selection.createRange():window.getSelection&&(sel=window.getSelection(),t=sel.getRangeAt(0),(n=document.createElement("span")).innerHTML="&#FEFF;",t.deleteContents(),t.insertNode(n),textRange=document.body.createTextRange(),textRange.moveToElementText(n),n.parentNode.removeChild(n)),textRange.text=a,textRange.collapse(!1),textRange.select()):document.execCommand("insertText",!1,a)}),$(this).on("keydown",function(e){if(e.ctrlKey||e.metaKey)switch(e.keyCode){case 66:case 98:case 73:case 105:case 85:case 117:e.preventDefault()}})})}var o={domain:"jshii.com.cn",ws:"ws://im.jshii.com.cn:6066",poll:"http://im.jshii.com.cn:6066",api:"http://im.jshii.com.cn:8080"},s=o.api,p={auth:s+"/customer/auth",opinion:s+"/opinion/rate",chatRecord:s+"/chat/before",hot:s+"/hot/question",uploadImage:s+"/upload/image",uploadImgb64:s+"/upload/imgb64",goodsDetail:s+"/goods/info",recommendList:s+"/recommend/list",orderList:s+"/order/list",logistics:s+"/order/logistics"},u={get:function(e,t,n,a,i){t.t=(new Date).getTime(),$.ajax({type:"GET",url:e,data:t,dataType:"json",async:n,xhrFields:{withCredentials:!0},success:function(e){a&&a instanceof Function&&a(e)},error:function(e){i&&i instanceof Function&&i(e)}})},post:function(e,t,n,a,i){t.t=(new Date).getTime(),$.ajax({type:"POST",url:e,data:t,dataType:"json",async:n,xhrFields:{withCredentials:!0},success:function(e){a&&a instanceof Function&&a(e)},error:function(e){i&&i instanceof Function&&i(e)}})},jsonp:function(e,t,n,a,i){t.t=(new Date).getTime(),$.ajax({type:"POST",url:e,data:t,dataType:"jsonp",async:n,jsonp:"callback",xhrFields:{withCredentials:!0},success:function(e){a&&a instanceof Function&&a(e)},error:function(e){i&&i instanceof Function&&i(e)}})},uploadImg:function(e,t,n,a,i){$.ajax({url:e,data:t,dataType:"json",type:"POST",async:n,processData:!1,contentType:!1,xhrFields:{withCredentials:!0},success:function(){a&&a instanceof Function&&a()},error:function(){i&&i instanceof Function&&i()}})}},m={build_success:"会话创建成功！",waitting_tip:"当前客服繁忙，已加入等候队列（您前面还有 {0} 个人）请您耐心等候...",service_info:"客服工号 {0} 为您提供服务~",close_tip:"会话已结束（回复再次咨询）."},f=1e3,v={getCookie:function(e){var t,n=new RegExp("(^| )"+e+"=([^;]*)(;|$)");return(t=document.cookie.match(n))?unescape(t[2]):"oc-"+(65536*(1+Math.random())|0).toString(16).substring(1)},getPid:function(){return f+++"-"+g()+"-"+g()+"-"+g()+"-"+g()+"-"+g()+g()+g()},dateFormat:function(e){var t=e&&e instanceof Date?e:new Date,n=t.getFullYear(),a=t.getMonth()+1,i=t.getDate();return n+"-"+(a<10?"0"+a:a)+"-"+(i<10?"0"+i:i)+" "+t.toTimeString().substr(0,8)},getUrlParams:function(){var e=decodeURI(location.search);if(1==e.indexOf("?"))return null;for(var t,n=(e=e.substr(1)).split("&"),a={},i=0;i<n.length;i++)a[(t=n[i].split("="))[0]]=t[1];return a},isMobile:function(){var e=navigator.userAgent;return!!e.match(/AppleWebKit.*Mobile.*/)||!!e.match(/AppleWebKit/)&&e.indexOf("QIHU")&&-1<e.indexOf("QIHU")&&e.indexOf("Chrome")<0},uploadImg:function(e,n){var t='<form id="submit_upload_img" method="post" action="'+e+'" enctype="multipart/form-data" target="iframe_upload_img" style="display: none"><input type="file" id="input_upload_img" name="file" accept=".jpg,.gif,.jpeg,.png" /></form>';$("#iframe_upload_img").remove(),$("#submit_upload_img").remove(),$("body").append('<iframe id="iframe_upload_img" name="iframe_upload_img" style="display: none"></iframe>'),$("body").append(t),$("#input_upload_img").change(function(){$("#submit_upload_img").submit()}),$("#iframe_upload_img").load(function(e){var t=$("#iframe_upload_img")[0].contentWindow.document.querySelector("body").innerHTML,t=JSON.parse(t);n&&n instanceof Function&&n(t)}),$("#input_upload_img").click()},uploadImgB64:function(e,t,n){var a='<form id="submit_upload_img" method="post" action="'+e+'" enctype="multipart/form-data" target="iframe_upload_img" style="display: none"><input id="input_upload_img" name="imgb64" value="'+t+'" accept=".jpg,.gif,.jpeg,.png" /></form>';$("#iframe_upload_img").remove(),$("#submit_upload_img").remove(),$("body").append('<iframe id="iframe_upload_img" name="iframe_upload_img" style="display: none"></iframe>'),$("body").append(a),$("#iframe_upload_img").load(function(e){var t=$("#iframe_upload_img")[0].contentWindow.document.querySelector("body").innerHTML,t=JSON.parse(t);n&&n instanceof Function&&n(t)}),$("#submit_upload_img").submit()},createImgHtml:function(e){return'<img src="'+e+'" style="max-width: 100%; max-height: 300px;" onload="conFitScroll()" />'},stopPropagation:function(e){window.showModalDialog?window.event.cancelBubble=!0:e.stopPropagation()}};function g(){return Math.floor(65535*(1+Math.random())).toString(16).substring(1)}!function(e,t){"object"===("undefined"==typeof exports?"undefined":n(exports))&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.iNotify=t()}(window,function(){function e(e){this.init(e||{})}var n=document.title;return e.prototype.init=function(e){this.open=!1,this.effect=e.effect||"flash",this.message=e.message||"有新消息了!",this.title=document.title||this.message,this.interval=e.interval||500,this.onceTime=e.onceTime||2e3,this.isActiveW=!1,this.onMonitor()},e.prototype.start=function(){var e=this;if(e.stop(),"flash"===e.effect){var t=!1;return e.flashInterval=setInterval(function(){document.title=t?n:e.message,t=!t},e.interval)}if("scroll"===e.effect)return document.title=e.message,e.scrollInterval=setInterval(function(){var e=document.title;document.title=e.substring(1,e.length)+e.substring(0,1),e=document.title.substring(0,e.length)},e.interval)},e.prototype.stop=function(){var e=this;return e.isActiveW=!1,clearTimeout(e.onceTimeout),"flash"===e.effect?(e.flashInterval&&clearInterval(e.flashInterval),document.title=n):"scroll"===e.effect?(e.scrollInterval&&clearInterval(e.scrollInterval),document.title=n):void 0},e.prototype.once=function(){var e=this;if(e.stop(),"flash"===e.effect||"scroll"===e.effect)return clearTimeout(e.onceTimeout),e.start(),e.onceTimeout=setTimeout(function(){e.stop()},e.onceTime)},e.prototype.onMonitor=function(){var e=this;window.onfocus=function(){e.isActiveW||(e.isActiveW=!0,e.stop())},document.onclick=function(){e.isActiveW||(e.isActiveW=!0,e.stop())}},e});var h=new iNotify({effect:"scroll",message:"您有新消息..."}),b={type:{inMessage:"inMessage",outMessage:"outMessage",broadcast:"broadcast"},render:function(e,t){switch(e){case this.type.inMessage:w(t);break;case this.type.outMessage:k(t);break;case this.type.broadcast:T(t)}},renderHistory:function(e){E(e)},renderBroadcast:function(e){$("#chat_service_status_msg").text(e)},renderHtml:function(e){C(e)},toScroll:function(){M()}},y="客服撤回一条消息";function w(e){var t=e.type;switch(t){case"BUILD_CHAT":ee.cid=e.cid,w.buildChat(e);break;case"MESSAGE":w.message(e);break;case"TRANSFER":w.transfer(e);break;case"BROADCAST":w.broadcast(e);break;case"CLOSE_CHAT":T(m.close_tip);break;case"REVOCATION":x(e);break;case"EVALUATE":$("#option_box").show()}h.open&&"PONG"!==t&&h.start()}function k(e){var t;switch(e.type){case"TEXT":t='<div class="user-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+v.dateFormat()+'</span><b>我</b></div><div class="chat-body">'+R(H.face.toEmoji(e.content))+"</div></div></div>";break;case"IMAGE":t='<div class="user-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+v.dateFormat()+'</span><b>我</b></div><div class="chat-body">'+H.face.toEmoji(e.content)+"</div></div></div>";break;case"ORDER":t='<div class="user-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+v.dateFormat()+'</span><b>我</b></div><div class="chat-body">'+D(e.content)+"</div></div></div>"}A(e,t)}function T(e){$("#chat_service_status_msg").text(e)}function x(e){var t=e.pid;$("div[pid="+t+"]").html("<div class='revocation'>"+y+"</div>")}function E(e){if(e){var t,n=I(e);switch(e.ownerType){case"1":t='<div class="user-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+e.createTime+'</span><b>我</b></div><div class="chat-body">'+n+"</div></div></div>";break;case"2":t='<div class="service-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+e.createTime+"</span><b>"+e.briefName+'</b><b class="left-space">'+e.waiterCode+'</b></div><div class="chat-body">'+n+"</div></div></div>";break;default:t="5"==e.messageType||"9"==e.messageType?'<div class="service-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+e.createTime+"</span><b>"+e.briefName+'</b><b class="left-space">'+e.waiterCode+'</b></div><div class="chat-body">'+n+"</div></div></div>":'<div class="robot-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+e.createTime+'</span><b>客服助手</b></div><div class="chat-body">'+n+"</div></div></div>"}$("#msg_box").prepend(t)}}function I(e){var t;switch(e.messageType){case"2":t=j(e.messages);break;case"10":t=O(e.messages);break;case"11":t=D(e.messages);break;case"12":t=S(e.messages);break;default:t=R(H.face.toEmoji(e.messages))}return t}function S(e){for(var t=JSON.parse(e),n='<div><div style="padding: 2px 0 8px 0; font-size: 13px;"><span>以下是最新物流信息：<span></div>',a=0;a<t.length;a++)n+="<div><span> "+t[a].lgtime+" </span></div><div><span> "+t[a].lgdesc+" </span></div>";return n+="</div>"}function O(e){var t=JSON.parse(e),n=0==ge?'<a href="'+t.wapUrl+'" target="_blank">'+t.name+"</a>":'<a href="'+t.pcUrl+'" target="_blank">'+t.name+"</a>";return n}function D(e){var t=JSON.parse(e);return'<div class="ordercard">\n                    <ul class="sendPrdUl">\n                        <li class="prdCodeLi">\n                            <div>\n                                <label style="padding-left: 8px;">订单号:</label>\n                                <span style="margin-left: -5px;">'.concat(t.orderCode,'</span><br>\n                                <label style="padding-left: 8px;">下单时间:</label>\n                                <span style="margin-left: -5px;">').concat(t.orderTime,'</span>\n                                <span style="float:right">\n                                    <b>').concat(t.orderStatusInfo,'</b>\n                                </span>\n                            </div>\n                        </li>\n                        <li class="prdLi">\n                            <div class="img">\n                                <img src="').concat(t.prdInfo.prdImgUrl,'" alt="">\n                            </div>\n                            <div class="prdLiDiv">\n                                <a href="').concat(t.prdInfo.prdDetailUrl,'" title="').concat(t.prdInfo.prdName,'" target="_blank" class="prdNameP">').concat(t.prdInfo.prdName,'</a>\n                                <p style="color: #999;">\n                                    <span>商品编号：</span>\n                                    <span style="margin-left: -0.5rem;">').concat(t.prdInfo.prdCode,'</span>\n                                </p>  \n                                <p class="prdInfoP">\n                                    <span>数量：</span>\n                                    <span style="padding-right: 8px; margin-left: -8px;">').concat(t.prdInfo.prdAcount,"</span>\n                                    <b>￥").concat(t.prdInfo.prdPrice,'</b>\n                                </p>\n                            </div>\n                        </li>\n                        <li class="prdAmountLi">\n                            <div style="position: relative">\n                                <span>共</span>\n                                <span style="margin-left: -4px;">').concat(t.orderAcount,'</span>\n                                <span style="padding-right: 8px; margin-left: -4px;">件</span>\n                                <span>订单金额：</span>\n                                <b style="color: #e2231a; margin-left: -12px;">￥').concat(t.orderAmount,"</b>\n                            </div>\n                        </li>\n                    </ul>\n                </div>").replace(/\n/gm,"")}function j(e){return'<img src="'+e+'" style="max-width: 100%; max-height: 300px;" onload="conFitScroll()"/>'}function C(e){$("#msg_box").append(e),M()}function A(e,t){var n;t&&((n=e.pid)&&(t='<div class="record" pid="'+n+'" >'+t+"</div>"),$("#msg_box").append(t)),M()}function M(){var e=$("#msg_box").height()-$("#chatDiv").height();0<e&&$("#chatDiv").scrollTop(40+e)}function R(e){return e.replace(/((((http?|https?):(?:\/\/)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)((?:\/[\+~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)/gi,function(e){var t=e;return 4<e.length&&"http"!==e.substr(0,4)&&(e="//"+e),'<a class="custom-link" href="'+e+'" target="_blank">'+t+"</a>"})}function N(e){var t=[];str=str.replace(/(http(s)?:\/\/)?([\w-]+\.)+[\w-]+(\/[\w\-\.\/?%&=]*)?/gi,function(e){return t.push(e),""}),str=str.replace(/(http(s)?:\/\/)?([\w-]+\.)+[\w-]+(\/[\w\-\.\/?%&=]*)?/g,function(e,t){return'<a class="custom-link" href="'+e+'" target="_blank">'+e+"</a>"}),str=str.replace(/\x01/g,function(e){return t.shift()})}w.buildChat=function(e){var t,n;switch(e.body.type){case"BUILDING_CHAT":T(e.body.content);break;case"WAITTING":T(m.waitting_tip.replace("{0}",e.body.content));break;case"SUCCESS":try{var a=JSON.parse(e.body.content);ee.tmb=a.tmb,ee.skn=a.skn}catch(e){}T(m.service_info.replace("{0}",e.from.uid));break;case"TEAM_GREET":case"WAITER_GREET":n=R(H.face.toEmoji(e.body.content)),t='<div class="service-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+e.datetime+"</span><b>"+(ee.tmb||"")+'</b><b class="left-space">'+e.from.uid+'</b></div><div class="chat-body">'+n+"</div></div></div>"}A(e,t)},w.message=function(e){var t,n;switch(e.body.type){case"TEXT":t=l.filterHtmlJsSpaceEnter(e.body.content),n='<div class="service-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+e.datetime+"</span><b>"+(ee.tmb||"")+'</b><b class="left-space">'+e.from.uid+'</b></div><div class="chat-body">'+R(H.face.toEmoji(t))+"</div></div></div>";break;case"TIMEOUT_TIP":n='<div class="robot-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+v.dateFormat()+'</span><b>客服助手</b></div><div class="chat-body">'+H.face.toEmoji(e.body.content)+"</div></div></div>";break;case"TIMEOUT_CLOSE":n='<div class="robot-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+v.dateFormat()+'</span><b>客服助手</b></div><div class="chat-body">'+H.face.toEmoji(e.body.content)+"</div></div></div>",T(m.close_tip);break;case"IMAGE":n='<div class="service-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+e.datetime+"</span><b>"+(ee.tmb||"")+'</b><b class="left-space">'+e.from.uid+'</b></div><div class="chat-body">'+v.createImgHtml(e.body.content)+"</div></div></div>";break;case"LOGISTICS":n='<div class="service-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+e.datetime+"</span><b>"+(ee.tmb||"")+'</b><b class="left-space">'+e.from.uid+'</b></div><div class="chat-body">'+S(e.body.content)+"</div></div></div>";break;case"GOODS":n='<div class="service-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+e.datetime+"</span><b>"+(ee.tmb||"")+'</b><b class="left-space">'+e.from.uid+'</b></div><div class="chat-body">'+O(e.body.content)+"</div></div></div>";break;case"ORDER":n='<div class="service-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+e.datetime+"</span><b>"+(ee.tmb||"")+'</b><b class="left-space">'+e.from.uid+'</b></div><div class="chat-body">'+D(e.body.content)+"</div></div></div>";break;case"TIP":case"ROBOT":n='<div class="robot-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+v.dateFormat()+'</span><b>客服助手</b></div><div class="chat-body">'+H.face.toEmoji(e.body.content)+"</div></div></div>";break;default:n='<div class="robot-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+v.dateFormat()+'</span><b>客服助手</b></div><div class="chat-body">'+H.face.toEmoji(e.body.content)+"</div></div></div>",T(m.close_tip)}A(e,n)},w.transfer=function(e){var t;if("SUCCESS"===e.body.type){T(m.service_info.replace("{0}",e.from.uid)),t='<div class="robot-chat clearfix"><div class="portrait icons"></div><div class="container"><div class="arrow icons"></div><div class="chat-head ell"><span>'+v.dateFormat()+'</span><b>客服助手</b></div><div class="chat-body">已为您转接客服工号：'+e.from.uid+"， 请输入您要咨询的问题。</div></div></div>";try{var n=JSON.parse(e.body.content);ee.tmb=n.tmb,ee.skn=n.skn}catch(e){}}A(e,t)},w.broadcast=function(e){"WAITTING_NO"===e.body.type&&T(m.waitting_tip.replace("{0}",e.body.content))};var F={first:!0},P={loadChatRecord:function(){var e={};F.id&&(e.id=F.id),F.more||u.jsonp(p.chatRecord,e,!0,function(e){if(0==e.rc){for(var t=e.data,n=t.length,a=0;a<n;a++)b.renderHistory(t[a]);F.first&&(F.first=!1,$("#load_chat_more").show(),$("#history_up").show()),F.id||b.toScroll(),0<n&&(F.id=t[n-1].id),n<10&&(F.more=!0,$(".load-chat-more").html("没有更多"))}})}},U=function(a){var i=a.customer;a.active=!1,o({type:"AUTH",ts:"POLLING",ttc:i.ttc,skc:i.skc,skn:i.skn,gc:i.gc,from:{idy:"CUSTOMER"},body:{type:"LOGIN"}},function(e){b.render(b.type.broadcast,m.build_success),function n(){var e={type:"POLL",ts:"POLLING",ttc:i.ttc,skc:i.skc,skn:i.skn,gc:i.gc,to:{idy:"WAITER"},from:{uid:i.cc,name:i.cn,idy:"CUSTOMER"},body:{type:"TEXT"}};$.ajax({type:"GET",url:a.url,data:{packet:JSON.stringify(e),t:(new Date).getTime()},dataType:"json",xhrFields:{withCredentials:!0},success:function(e){if(e&&e instanceof Array)for(var t=0;t<e.length;t++)b.render(b.type.inMessage,e[t]);a.active&&setTimeout(n(),1e3)},error:function(e){console.log("请求失败： "+e)}})}(),a.active=!0,t()});var t=function(){$(document).delegate("#message_area","keydown",function(e){if(e.ctrlKey||e.metaKey||e.altKey||$("#message-area").focus(),13===e.which){var t="";return""===(t=$("#message_area").val())?(ne.showDialog({content:"消息不能为空"}),!1):(t&&300<t.length?ne.showDialog({content:"消息不能超过300字"}):(t&&t.length<=300&&($("#message_area").val(""),t=l.filterHtmlJsSpaceEnter(t),1===ge?$("#message_area").focus():$("#message_area").blur(),c(t,"TEXT"),b.render(b.type.outMessage,{content:t,type:"TEXT"})),e.preventDefault()),!1)}}),$(document).delegate("#send_msg_btn","click",function(){var e="";return""===(e=$("#message_area").val())?ne.showDialog({content:"消息不能为空"}):e&&300<e.length?ne.showDialog({content:"消息不能超过300字"}):(e&&e.length<=300&&($("#message_area").val(""),e=l.filterHtmlJsSpaceEnter(e),1===ge?$("#message_area").focus():$("#message_area").blur(),c(e,"TEXT"),b.render(b.type.outMessage,{content:e,type:"TEXT"})),event.preventDefault()),!1})};function c(e,t){var n={type:"MESSAGE",ts:"POLLING",ttc:i.ttc,skc:i.skc,skn:i.skn,gc:i.gc,to:{idy:"WAITER"},from:{uid:i.cc,name:i.cn,idy:"CUSTOMER"},body:{type:t,content:e}};o(n,function(e){console.log("消息发送成功!"+JSON.stringify(n))})}function o(e,t,n){e&&(e.pid=v.getPid(),$.ajax({type:"GET",url:a.url,data:{packet:JSON.stringify(e),t:(new Date).getTime()},dataType:"json",xhrFields:{withCredentials:!0},success:function(e){t(e)},error:function(e){n&&n instanceof Function&&n(e),console.log("发送消息失败：{}",JSON.stringify(e))}}))}return{sendImg:function(e,t,n){c(t,n),b.render(b.type.outMessage,{content:e,type:"IMAGE"})},sendMsg:function(e,t){c(e,t),b.render(b.type.outMessage,{content:e,type:t})},close:function(){opt.active=!1,o({type:"CLOSE",ts:"POLLING",ttc:i.ttc,skc:i.skc,skn:i.skn,gc:i.gc,to:{idy:"WAITER"},from:{uid:i.cc,name:i.cn,idy:"CUSTOMER"}},function(e){console.log("关闭!")})}}},L=function(t){var n,a,i=t.customer,c=!1,o=!0;function e(){var e=t.url+"?packet="+JSON.stringify({type:"AUTH",ts:"WEBSOCKET",from:{idy:"CUSTOMER"},body:{type:"LOGIN"}})+"&t="+(new Date).getTime();(a=new WebSocket(e)).onopen=function(){c=!1,b.render(b.type.broadcast,m.build_success),clearInterval(n),n=setInterval(function(){r({type:"PING",ts:"WEBSOCKET",body:{type:"TEXT",content:"PING"}})},3e4)},a.onmessage=function(e){"RE_LOGIN"==(e=JSON.parse(e.data)).type?(o=!0,clearInterval(n),b.renderBroadcast("已在其他打开咨询，当前会话被关闭")):b.render(b.type.inMessage,e)},a.onerror=function(e){c=!0,b.render(b.type.broadcast,"糟糕，网络错误，工程师正在维护中...")},a.onclose=function(){o||(c||b.render(b.type.broadcast,"糟糕，网络连接断开"),d())},$(document).delegate("#message_area","keydown",function(e){if(e.ctrlKey||e.metaKey||e.altKey||$("#message-area").focus(),13===e.which)return $("#send_msg_btn").click(),e.preventDefault(),!1}),$("#send_msg_btn").on("click",function(){var e=$("#message_area").val();return""===e?ne.showDialog({content:"消息不能为空"}):e&&300<e.length?ne.showDialog({content:"消息不能超过300字"}):(e&&e.length<=300&&($("#message_area").val(""),e=l.filterHtmlJsSpaceEnter(e),1===ge?$("#message_area").focus():$("#message_area").blur(),s(e,"TEXT"),b.render(b.type.outMessage,{content:e,type:"TEXT"})),event.preventDefault()),!1})}function s(e,t){r({type:"MESSAGE",ts:"WEBSOCKET",from:{uid:i.cc,name:i.cn,idy:"CUSTOMER"},body:{type:t,content:e}})}function r(e){e&&(1===a.readyState?(e.pid=v.getPid(),e.to={idy:"WAITER"},a.send(JSON.stringify(e))):d())}function d(){3===a.readyState&&(clearInterval(n),setTimeout(e,5e3))}return e(),{sendImg:function(e,t,n){s(t,n),b.render(b.type.outMessage,{content:e,type:"IMAGE"})},sendMsg:function(e,t){s(e,t),b.render(b.type.outMessage,{content:e,type:t})},close:function(){1==a.readyState&&a.close()}}},G={em:void 0,toEmoji:void 0,show:void 0,hide:void 0},H={face:z()};function W(e,a){var t;$(e).append('<div class="emoji-inner"><ul class="emoji-nav"></ul><div class="emoji-content"></div></div>'),a.showbar?(t=_.reduce(a.category,function(e,t){var n=_.find(a.data,function(e){return e.typ==t});return e+'<li data-name="'+t+'">'+n.nm+"</li>"},""),$(e).find(".emoji-nav").empty().append(t)):$(e).addClass("no-bar")}function J(e,n,t){var a=(a=_.find(n.data,function(e){return e.typ==t}))||n.data[0],i=_.reduce(a.items,function(e,t){return t?e+'<img title="'+t.name+'" src="'+n.path+t.src+'" data-name="'+t.name+'" data-src="'+n.path+t.src+'">':e},"");$(e).find(".emoji-content").empty().append(i),$(e).find(".emoji-nav li[data-name="+a.typ+"]").addClass("on").siblings().removeClass("on")}function B(e,t){$(e).on(t.trigger,".emoji-nav > li",function(){return J(e,t,$(this).attr("data-name")),!1}),$(e).on("click",".emoji-content > img",function(){t.insertAfter({name:$(this).attr("data-name"),src:$(this).attr("data-src")})})}function K(e,t){$(e).on("click",".emoji-tbtn",function(){return $(e).find(".emoji-inner").toggle(),!1}),$(document).click(function(){$(e).hide(),$(e).find(".emoji-inner").hide()})}function X(e){var t=$("#emoji_container"),n=$.extend({},Q(),e||{});return G.hide=function(){t.hide(),t.find(".emoji-inner").hide()},G.show=function(){t.show(),t.find(".emoji-inner").show()},t.each(function(){return!(0<!t.find(".val").length)&&(W(t,n),J(t,n),B(t,n),void K(t,n))})}function q(e,t){var n,a,i,c,o,s,r=$("#message_area"),d=r[0];window.getSelection?(n=d.selectionStart,a=d.selectionEnd,i=d.scrollTop,d.value=d.value.substring(0,n)+e+d.value.substring(a,d.value.length),r.focus(),d.selectionStart=n+e.length,d.selectionEnd=n+e.length,d.scrollTop=i,2==arguments.length&&(d.setSelectionRange(n-t,d.selectionEnd+t),r.focus())):document.selection?(r.focus(),(c=document.selection.createRange()).text=e,r.focus(),c.moveStart("character",-s),o=c.text.length,2==arguments.length&&(s=d.value.length,c.moveEnd("character",o+t),t<=0?c.moveStart("character",o-2*t-e.length):c.moveStart("character",o-t-e.length),c.select())):(r.value+=e,r.focus()),$("#input-add-field").hide(),$("#send_msg_btn").show()}function z(){var a={insertAfter:function(e){q("[:"+e.name+":]")},path:"images/"};X(a);var i=Y();return G.toEmoji=function(e){var t=[];_.each(i,function(e){null!==e&&t.push(e.name)});var n=new RegExp("\\[:("+(1<t.length?t.join("|"):t+"")+"):\\]","g");return e.replace(n,function(t){t=t.replace("[:","").replace(":]","");var e=_.filter(i,function(e){return null!=e&&e.name==t});return'<img name="[:'+t+':]" src="'+a.path+e[0].src+'" alt="'+t+'" style="width: 25px;height: 25px;cursor: pointer;vertical-align: middle;"/>'})},G}function Y(t){for(var e=t?this.data=_.filter(Q().data,function(e){return _.contains(t,e.typ)}):Q().data,n=0,a=e.length,i=[];n<a;n++)for(var c=e[n].items,o=0,s=c.length;o<s;o++)i.push(c[o]);return i}function Q(){return{data:[{typ:"EmojiCategory-People",nm:"人物",items:[{name:"笑脸",src:"face/笑脸.png"},{name:"开心",src:"face/开心.png"},{name:"大笑",src:"face/大笑.png"},{name:"爱心",src:"face/爱心.png"},{name:"飞吻",src:"face/飞吻.png"},{name:"调皮",src:"face/调皮.png"},{name:"讨厌",src:"face/讨厌.png"},{name:"笑哭",src:"face/笑哭.png"},{name:"流泪",src:"face/流泪.png"},{name:"坏笑",src:"face/坏笑.png"},{name:"流汗",src:"face/流汗.png"},{name:"汗颜",src:"face/汗颜.png"},{name:"尴尬",src:"face/尴尬.png"},{name:"流泪",src:"face/流泪.png"},{name:"冷酷",src:"face/冷酷.png"},{name:"惊恐",src:"face/惊恐.png"},{name:"惊悚",src:"face/惊悚.png"},{name:"惊讶",src:"face/惊讶.png"},{name:"大惊",src:"face/大惊.png"},{name:"大闹",src:"face/大闹.png"},{name:"发呆",src:"face/发呆.png"},{name:"犯困",src:"face/犯困.png"},{name:"心碎",src:"face/心碎.png"},{name:"酷",src:"face/酷.png"},{name:"生气",src:"face/生气.png"},{name:"闭嘴",src:"face/闭嘴.png"},{name:"睡着",src:"face/睡着.png"},{name:"奋斗",src:"face/奋斗.png"},{name:"愤怒",src:"face/愤怒.png"},{name:"瞌睡",src:"face/瞌睡.png"},{name:"难过",src:"face/难过.png"},{name:"天使",src:"face/天使.png"},{name:"无聊",src:"face/无聊.png"},{name:"骂人",src:"face/骂人.png"},{name:"点赞",src:"face/点赞.png"},{name:"懵逼",src:"face/懵逼.png"},{name:"白眼",src:"face/白眼.png"},{name:"恶魔",src:"face/恶魔.png"},{name:"感冒",src:"face/感冒.png"},{name:"爱你",src:"face/爱你.png"},{name:"呕吐",src:"face/呕吐.png"},{name:"呲牙",src:"face/呲牙.png"}]}],path:"images/",category:["EmojiCategory-People"],showbar:!0,trigger:"click",insertAfter:function(){}}}var V,Z,ee,te,ne={showDialog:function(a){!function(){var e='<div id="p_dialog_header"><div id="p_dialog_header_name">'+(a=$.extend({title:"提示",content:"提示框"},a)).title+'</div><div id="p_dialog_close"></div></div>',t='<div id="p_dialog_content">'+a.content+"</div>";$("#p_dialog_mask_wrapper").remove();var n='<div id="p_dialog_mask_wrapper"><div id="p_dialog_container">'+e+t+'<div id="p_dialog_opts"><span id="p_dialog_submit">关闭</span></div></div>';$("body").append(n),$("#p_dialog_mask_wrapper").on("click",function(){$("#p_dialog_mask_wrapper").remove()}),$("#p_dialog_close").on("click",function(){$("#p_dialog_mask_wrapper").remove()}),$("#p_dialog_container").on("click",function(e){v.stopPropagation(e)}),$("#p_dialog_submit").on("click",function(){$("#p_dialog_mask_wrapper").remove()})}()}},ae={startChat:function(){oe(),se()}},ie=[],ce=1;function oe(){me(),fe(),de()}function se(){window.onbeforeunload=function(e){te.close()},$(document).click(function(e){0==$(e.target).closest("#emoji_container").length&&($("#emoji_container").hide(),H.face.hide())}),$("#message_area").unbind("paste").bind("paste",function(e){le(e)}),$("#set-file").unbind("click").bind("click",function(){return v.uploadImg(p.uploadImage,function(e){var t;0==e.rc?(t=v.createImgHtml(e.imgurl,!0),te.sendImg(t,e.imgurl,"IMAGE")):ne.showDialog({content:e.rm})}),!1}),$("#send-imgb64").bind("click",function(){return V?(v.uploadImgB64(p.uploadImgb64,V,function(e){var t;0==e.rc?($(".ay-mask").hide(),t=v.createImgHtml(e.imgurl,!0),te.sendImg(t,e.imgurl,"IMAGE")):ne.showDialog({content:e.rm})}),!0):($(".ay-mask").hide(),ne.showDialog({content:"未获取到图片信息，请重新操作"}),!1)}),$("#send-imgb64-cancel").bind("click",function(){return $(".ay-mask").hide(),!0}),$("#set-evaluate").unbind("click").bind("click",function(){if(!ee.cid)return ne.showDialog({content:"咨询后在评价的哦!"}),!1;if($("#opinion_submit").data("isOpinion"))return ne.showDialog({content:"您已经评论过了!"}),!1;var e=$("#option_box");return e.is(":visible")?e.hide():e.show(),!1}),$("#option_box").delegate(".close-tool,.cancel","click",function(){return $("#option_box").hide(),!1}).delegate("input[name=evaluation]:radio","change",function(){var e=$("input[name=evaluation]:radio:checked").val()||"5";"1"==e||"2"==e||"3"==e?$("#suggest_box").css("visibility","visible"):$("#suggest_box").css("visibility","hidden")}).delegate("#opinion_submit","click",function(){if($("#opinion_submit").data("isOpinion"))return ne.showDialog({content:"您已经评论过了!"}),!1;var e=$("input[name=evaluation]:radio:checked").val()||"",t=$("#opinion_desp").val();if(("1"==e||"2"==e)&&$.trim(t).length<10)return ne.showDialog({content:"请填写您的建议且建议内容至少10个字!"}),$("#opinion_desp").focus(),!1;$.trim(t)&&(t=l.filterHtmlJsSpaceEnter(t));var n={chatId:ee.cid,opinion:e,suggest:t};n.chatId&&n.opinion&&("1"!=n.opinion||"2"!=n.opinion)||n.chatId&&n.opinion&&("1"==n.opinion||"2"==n.opinion)&&n.suggest?re(p.opinion,n):ne.showDialog({content:"请完善评论信息!"})})}function re(e,t){u.jsonp(e,t,!0,function(e){return 0==e.rc?($("#opinion_desp").val(""),$("div.choise-eva input").removeAttr("checked"),$("#opinion_submit").data("isOpinion",!0),ne.showDialog({content:e.rm}),$("#option_box").hide(),!1):void ne.showDialog({content:e.rm})})}function de(){$("#opinion_desp").val(""),$("#set-face").click(function(){return $("#emoji_container").show(),H.face.show(),!1})}function le(e){var t,n,a,i=e.originalEvent.clipboardData,c=0;if(i){if(!(t=i.items))return;for(n=t[0],a=i.types||[];c<a.length;c++)if("Files"===a[c]){n=t[c];break}n&&"file"===n.kind&&n.type.match(/^image\//i)&&pe(n)}}function pe(e){var t=e.getAsFile(),n=new FileReader;n.onload=function(e){V=e.target.result,$("#showPic").html(""),$("#showPic").append('<p><img id="pasteImg" src="'+e.target.result+'" class="sendImg"></p>'),$("#pasteImg").attr("style","max-width: 480px; max-height:200px"),$(".ay-mask").show()},n.readAsDataURL(t)}function ue(){ee&&1==ee.real?(P.loadChatRecord(),$("#load_chat_more").bind("click",function(){P.loadChatRecord()})):($(".load-chat-more").hide(),$(".history-up").hide())}function me(){$("#hot_tab").unbind("click").bind("click",function(){$("#hot_tab").siblings().removeClass("active").end().addClass("active"),$("#hot_list").siblings().hide().end().show()})}function fe(){u.jsonp(p.hot,{},!0,function(e){var n;0==e.rc?(n=[],$("#hot_ul").val(""),$.each(e.data,function(e,t){n.push('<li><h6><a href="javascript:;">'+(e+1)+". "+t.question+'</a></h6><div class="answer" style="display: none;"><i class="icons"></i><p style="font-size:12px;">'+t.answer+"</p></div></li>")}),ve(),$("#hot_ul").append(n.join(""))):ne.showDialog({content:e.rm})})}function ve(){$("#hot_ul li h6").click(function(){var e=$(this),t=e.next(),n=e.find("a"),a=e.parent();return t.is(":visible")?(n.removeClass("active"),t.slideUp()):(n.addClass("active"),t.slideDown(),a.siblings().find(".answer").slideUp(),a.siblings().find("h6 a").removeClass("active")),!1})}ve();var ge=1,he=!!window.WebSocket;function be(){var e=v.getUrlParams(),i={ttc:e.ttc?e.ttc:1,skc:e.skc,buc:e.buc,gc:e.gc,device:ge,origin:1,io:he?"ws":"poll"};u.jsonp(p.auth,i,!1,function(e){switch(e.rc){case 0:_e(ee=e.data),ue(),ae.startChat(),e.skn&&-1!==e.skn.indexOf("EFF")&&(i.ttc=3);break;case 1:var t=encodeURIComponent(window.location.href);e.data&&e.data.loginUrl?window.location.href=e.data.loginUrl+"&ru="+t:ne.showDialog({content:e.rm});break;case 2:ue();var n="",n=e.data&&e.data.offlineMsg?e.data.offlineMsg:e.rm;ne.showDialog({content:n}),$("#chat_service_status_msg").text(n);break;case 3:var a=window.location.host;window.location.href="//"+a;break;case 5:$(".service-panel").hide(),ne.showDialog({content:"由于在咨询过程中，咨询内容包含不合法信息，已暂时限制咨询请求！"});break;default:$(".service-panel").hide(),ne.showDialog({content:"初始化信息失败，请重试！"})}},function(e){$(".service-panel").hide(),ne.showDialog({content:"初始化信息失败，请重试！"})})}function _e(e){h.open=!0,te=he?L({url:o.ws+"/ws.io",customer:e}):U({url:o.poll+"/poll.io",customer:e})}$(function(){document.domain=o.domain,be()});